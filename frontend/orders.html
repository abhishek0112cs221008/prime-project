<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Project - Orders</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-brand-logo">
            <div class="mi-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                    stroke-linejoin="round">
                    <path d="M7 12h5a5 5 0 1 0 0-10H7v10Z" />
                    <path d="M7 22v-10" />
                </svg>
            </div>
            <span class="logo-name">Prime Project</span>
        </a>
        <div class="nav-links">
            <a href="index.html">
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
                Projects
            </a>
            <a href="cart.html">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                </svg>
                Cart
            </a>
            <a href="orders.html" class="active">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
                </svg>
                Orders
            </a>
            <span id="auth-links"></span>
        </div>
        <div class="flip-clock">
            <div class="flip-unit" id="hr1">0</div>
            <div class="flip-unit" id="hr2">0</div>
            <span class="clock-sep">:</span>
            <div class="flip-unit" id="min1">0</div>
            <div class="flip-unit" id="min2">0</div>
            <span class="clock-sep">:</span>
            <div class="flip-unit" id="sec1">0</div>
            <div class="flip-unit" id="sec2">0</div>
            <span class="clock-ampm" id="ampm">AM</span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">◐</button>
    </nav>
    <script src="js/watch.js"></script>

    <div class="container">
        <h1 style="margin-bottom: 5px;">Your Orders.</h1>
        <p style="text-align: center; margin-bottom: 30px; color: var(--text-secondary);">Track, return, or buy again.
        </p>

        <!-- Search Bar -->
        <div class="search-container" style="margin-bottom: 25px;">
            <input type="text" id="order-search" class="search-input"
                placeholder="Search orders by product name, ID, or status..." autocomplete="off">
            <svg class="search-icon" viewBox="0 0 24 24">
                <path
                    d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
            </svg>
        </div>

        <!-- Filter Sections -->
        <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px;">
            <div id="category-bar" class="category-bar" style="margin-bottom: 0;">
                <!-- Categories will be injected here -->
            </div>
            <div id="status-bar" class="category-bar" style="margin-bottom: 0;">
                <!-- Status chips will be injected here -->
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>DATE PLACED</th>
                    <th>ORDER ID</th>
                    <th>PRODUCT</th>
                    <th>STATUS</th>
                    <th style="text-align: right;">ACTION</th>
                </tr>
            </thead>
            <tbody id="order-list"></tbody>
        </table>
    </div>

    <footer>
        <div class="footer-content">
            <p>Copyright © 2026 Prime Project Inc. All rights reserved.</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Use</a>
                <a href="#">Sales and Refunds</a>
                <a href="#">Legal</a>
                <a href="#">Site Map</a>
            </div>
        </div>
    </footer>

    <!-- Bottom Nav for Mobile -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            <span>Home</span>
        </a>
        <a href="#"
            onclick="if(window.openCart) { openCart(); return false; } else { window.location.href='cart.html'; return false; }"
            class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <span>Cart</span>
        </a>
        <a href="orders.html" class="bottom-nav-item active">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
            </svg>
            <span>Orders</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <span>Profile</span>
        </a>
    </nav>

    <script src="js/api.js"></script>
    <script>
        if (!requireLogin()) throw new Error("Redirecting");

        let allOrders = [];
        let selectedCategory = 'All';
        let selectedStatus = 'All';

        async function loadOrders() {
            const orders = await Api.get('/orders');
            if (!orders) return;

            // Time-wise sorting: Most recent first
            allOrders = orders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));

            renderFilters();
            filterOrders();
        }

        function renderFilters() {
            // Category Bar
            const categories = ['All', ...new Set(allOrders.map(o => o.product.category))];
            const catBar = document.getElementById('category-bar');
            if (catBar) {
                catBar.innerHTML = categories.map(cat => `
                    <div class="category-chip ${selectedCategory === cat ? 'active' : ''}" onclick="selectCategory('${cat}')">
                        ${cat}
                    </div>
                `).join('');
            }

            // Status Bar
            const statuses = ['All', 'Confirmed', 'Pending', 'Rejected'];
            const statusBar = document.getElementById('status-bar');
            if (statusBar) {
                statusBar.innerHTML = statuses.map(status => `
                    <div class="category-chip ${selectedStatus === status ? 'active' : ''}" onclick="selectStatus('${status}')">
                        ${status}
                    </div>
                `).join('');
            }
        }

        function selectCategory(cat) {
            selectedCategory = cat;
            renderFilters();
            filterOrders();
        }

        function selectStatus(status) {
            selectedStatus = status;
            renderFilters();
            filterOrders();
        }

        function filterOrders() {
            const query = document.getElementById('order-search').value.toLowerCase();
            const container = document.getElementById('order-list');

            const filtered = allOrders.filter(o => {
                const productName = o.product.name.toLowerCase();
                const paymentIdStr = (o.paymentId || '').toLowerCase();

                // Determine order's logical status to match filter UI and display badges
                const isConfirmed = o.verified || o.status === 'Confirmed';
                const isRejected = o.status === 'Rejected';
                const logicalStatus = isConfirmed ? 'Confirmed' : (isRejected ? 'Rejected' : 'Pending');

                const matchesSearch = productName.includes(query) || paymentIdStr.includes(query) || logicalStatus.toLowerCase().includes(query);
                const matchesCategory = selectedCategory === 'All' || o.product.category === selectedCategory;
                const matchesStatus = selectedStatus === 'All' || logicalStatus === selectedStatus;

                return matchesSearch && matchesCategory && matchesStatus;
            });

            if (filtered.length === 0) {
                container.innerHTML = `<tr><td colspan="5" style="text-align:center; padding: 60px 20px;">
                    <h3 style="color: var(--text-secondary); opacity: 0.6;">No orders match your filters.</h3>
                    <p style="margin-top: 10px;">Try adjusting your search or filters.</p>
                </td></tr>`;
                return;
            }

            container.innerHTML = filtered.map(o => {
                const isConfirmed = o.verified || o.status === 'Confirmed';
                const isRejected = o.status === 'Rejected';
                const statusClass = isConfirmed ? 'status-confirmed' : (isRejected ? 'status-rejected' : 'status-pending');
                const displayId = (o.paymentId || 'UNKNOWN').substring(0, 8);

                return `
                    <tr>
                        <td data-label="Date" class="order-date-td">${new Date(o.orderDate).toLocaleDateString()}</td>
                        <td data-label="Order ID" class="order-id-td">#${displayId}</td>
                        <td data-label="Product" class="order-product-td">
                            <div class="product-name">${o.product.name}</div>
                            <div class="project-id-meta">PROJECT ID: #${o.product.id}</div>
                        </td>
                        <td data-label="Status" class="order-status-td">
                            <span class="status-badge ${statusClass}">
                                ${isConfirmed ? 'CONFIRMED' : (isRejected ? 'REJECTED' : 'PENDING')}
                            </span>
                            ${isRejected && o.rejectionReason ? `<div class="rejection-reason">Reason: ${o.rejectionReason}</div>` : ''}
                        </td>
                        <td data-label="Action" class="order-action-td">
                            ${isConfirmed
                        ? `<button onclick="accessProject(${o.id}, '${o.product.name.replace(/'/g, "\\'")}')" class="secondary view-details-btn">View Purchase Details</button>`
                        : (isRejected
                            ? `<span class="contact-support-link">Contact Support</span>`
                            : `<div class="verifying-status">
                                 <span class="pulse-dot"></span>
                                 Verifying payment...
                               </div>`)}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Search Input Listener
        document.getElementById('order-search')?.addEventListener('input', filterOrders);

        async function accessProject(orderId, productName) {
            try {
                const res = await Api.get(`/orders/${orderId}/access`);

                let modal = document.getElementById('content-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'content-modal';
                    modal.className = 'sheet-overlay';
                    document.body.appendChild(modal);
                }

                modal.innerHTML = `
                    <div id="modal-sheet" class="bottom-sheet">
                        <div class="sheet-handle"></div>
                        <button class="sheet-close-btn" onclick="closeModal()">×</button>
                        
                        <h2 style="margin-top: 0; margin-bottom: 5px; font-size: 24px;">${productName}</h2>
                        <p style="color: var(--accent-color); font-size: 13px; margin-top: 0; margin-bottom: 30px;">Authenticated & Verified • ${new Date().toLocaleDateString()}</p>
                        
                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; margin-bottom: 30px; border: 1px solid var(--border-color);">
                            <h4 style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Git Repository</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <code style="flex: 1; padding: 12px 15px; background: rgba(0,0,0,0.3); color: var(--text-color); border-radius: 10px; font-family: monospace; border: 1px solid var(--border-color); font-size: 13px;">${res.gitRepoUrl || 'No URL provided'}</code>
                                <button onclick="window.open('${res.gitRepoUrl}', '_blank')" style="border-radius: 10px; padding: 0 20px; width: auto;">Open</button>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 15px; font-size: 16px;">Installation Instructions</h4>
                        <div style="line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 13px; background: rgba(0,0,0,0.03); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); max-height: 300px; overflow-y: auto;">${res.installationGuide || 'No specific instructions provided.'}</div>

                        <div style="margin-top: 40px; text-align: center; opacity: 0.5;">
                            <p style="font-size: 11px;">Licensed to you. Do not distribute.</p>
                        </div>
                    </div>
                `;

                modal.style.display = 'flex';
                // Trigger animation with double rAF
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        modal.classList.add('active');
                    });
                });

                // Close function
                window.closeModal = function () {
                    modal.classList.remove('active');
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 400);
                }

                // Close on click outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

            } catch (e) {
                alert("Access Denied: " + e.message);
            }
        }

        loadOrders();
    </script>
</body>

</html>