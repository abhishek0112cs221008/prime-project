<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Project - Orders</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-brand">Prime Project</a>
        <div class="nav-links">
            <a href="index.html">
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
                Projects
            </a>
            <a href="cart.html">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                </svg>
                Cart
            </a>
            <a href="orders.html" style="color: var(--accent-color)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
                </svg>
                Orders
            </a>
            <span id="auth-links"></span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">◐</button>
    </nav>

    <div class="container">
        <h1>Your Orders.</h1>
        <p style="text-align: center; margin-bottom: 40px;">Track, return, or buy again.</p>

        <table>
            <thead>
                <tr>
                    <th
                        style="text-align: left; padding: 15px 0; color: var(--text-secondary); font-weight: normal; font-size: 12px;">
                        DATE PLACED</th>
                    <th
                        style="text-align: left; padding: 15px 0; color: var(--text-secondary); font-weight: normal; font-size: 12px;">
                        ORDER ID</th>
                    <th
                        style="text-align: left; padding: 15px 0; color: var(--text-secondary); font-weight: normal; font-size: 12px;">
                        PRODUCT</th>
                    <th
                        style="text-align: left; padding: 15px 0; color: var(--text-secondary); font-weight: normal; font-size: 12px;">
                        STATUS</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="order-list"></tbody>
        </table>
    </div>

    <footer>
        <div class="footer-content">
            <p>Copyright © 2026 Prime Project Inc. All rights reserved.</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Use</a>
                <a href="#">Sales and Refunds</a>
                <a href="#">Legal</a>
                <a href="#">Site Map</a>
            </div>
        </div>
    </footer>

    <!-- Bottom Nav for Mobile -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            <span>Home</span>
        </a>
        <a href="#"
            onclick="if(window.openCart) { openCart(); return false; } else { window.location.href='cart.html'; return false; }"
            class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <span>Cart</span>
        </a>
        <a href="orders.html" class="bottom-nav-item active">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
            </svg>
            <span>Orders</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <span>Profile</span>
        </a>
    </nav>

    <script src="js/api.js"></script>
    <script>
        if (!requireLogin()) throw new Error("Redirecting");

        async function loadOrders() {
            const orders = await Api.get('/orders');
            if (!orders) return;

            const container = document.getElementById('order-list');
            if (orders.length === 0) {
                container.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 40px;">You have no orders yet.</td></tr>';
                return;
            }
            container.innerHTML = orders.map(o => `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 20px 0; color: var(--text-secondary);">${new Date(o.orderDate).toLocaleDateString()}</td>
                    <td style="padding: 20px 0; font-family: monospace; font-size: 14px;">${o.paymentId.substring(0, 8)}...</td>
                    <td style="padding: 20px 0;">
                        <span style="font-weight: 500; font-size: 16px;">${o.product.name}</span>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">ID: #${o.product.id}</div>
                    </td>
                    <td style="padding: 20px 0;">
                        <span style="display:inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; border: 1px solid ${o.status === 'Rejected' ? 'red' : (o.verified || o.status === 'Confirmed' ? 'var(--accent-color)' : 'var(--border-color)')}; color: ${o.status === 'Rejected' ? 'red' : (o.verified || o.status === 'Confirmed' ? 'var(--accent-color)' : 'var(--text-secondary)')};">
                            ${o.status.toUpperCase()}
                        </span>
                        ${o.status === 'Rejected' && o.rejectionReason ? `<div style="font-size: 11px; color: red; margin-top: 5px;">Reason: ${o.rejectionReason}</div>` : ''}
                    </td>
                    <td style="padding: 20px 0; text-align: right;">
                        ${o.verified || o.status === 'Confirmed'
                    ? `<button onclick="accessProject(${o.id}, '${o.product.name.replace(/'/g, "\\'")}')" class="secondary" style="font-size: 13px;">View Purchase Details</button>`
                    : (o.status === 'Rejected' ? `<span style="font-size: 12px; color: red;">Contact Support</span>` : `<span style="font-size: 12px; color: var(--text-secondary);">Verifying payment...</span>`)}
                    </td>
                </tr>
            `).join('');
        }

        async function accessProject(orderId, productName) {
            try {
                const res = await Api.get(`/orders/${orderId}/access`);

                const modal = document.createElement('div');
                modal.id = 'content-modal';
                modal.style.cssText = `
                    position: fixed; inset: 0;
                    background: rgba(0,0,0,0); 
                    z-index: 2000;
                    display: flex; align-items: flex-end; justify-content: center;
                    transition: background 0.4s cubic-bezier(0.32, 0, 0.67, 0), backdrop-filter 0.4s;
                    backdrop-filter: blur(0px);
                `;

                // iOS-style sheet
                const sheetStyle = `
                    background: var(--bg-color); 
                    width: 100%; max-width: 700px; 
                    padding: 40px; 
                    border-radius: 20px 20px 0 0; 
                    position: relative; 
                    max-height: 85vh; 
                    overflow-y: auto; 
                    border-top: 1px solid var(--border-color);
                    box-shadow: 0 -10px 40px rgba(0,0,0,0.3);
                    transform: translateY(100%);
                    transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
                `;

                modal.innerHTML = `
                    <div id="modal-sheet" style="${sheetStyle}">
                        <div style="width: 40px; height: 5px; background: var(--text-secondary); border-radius: 3px; margin: -20px auto 30px; opacity: 0.2;"></div>
                        <button onclick="closeModal()" style="position: absolute; top: 25px; right: 25px; background: rgba(128,128,128,0.1); width: 30px; height: 30px; border-radius: 50%; color: var(--text-color); font-size: 18px; border: none; cursor: pointer; display:flex; align-items:center; justify-content:center;">×</button>
                        
                        <h2 style="margin-top: 0; margin-bottom: 5px; font-size: 24px;">${productName}</h2>
                        <p style="color: var(--accent-color); font-size: 13px; margin-top: 0; margin-bottom: 30px;">Authenticated & Verified • ${new Date().toLocaleDateString()}</p>
                        
                        <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 16px; margin-bottom: 30px; border: 1px solid var(--border-color);">
                            <h4 style="margin: 0 0 12px 0; color: var(--text-secondary); font-size: 11px; text-transform: uppercase; letter-spacing: 1px;">Git Repository</h4>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <code style="flex: 1; padding: 12px 15px; background: rgba(0,0,0,0.3); color: var(--text-color); border-radius: 10px; font-family: monospace; border: 1px solid var(--border-color); font-size: 13px;">${res.gitRepoUrl || 'No URL provided'}</code>
                                <button onclick="window.open('${res.gitRepoUrl}', '_blank')" style="border-radius: 10px; padding: 0 20px;">Open</button>
                            </div>
                        </div>

                        <h4 style="margin-bottom: 15px; font-size: 16px;">Installation Instructions</h4>
                        <div style="line-height: 1.6; color: var(--text-secondary); white-space: pre-wrap; font-family: 'Consolas', monospace; font-size: 13px; background: rgba(0,0,0,0.03); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); max-height: 300px; overflow-y: auto;">${res.installationGuide || 'No specific instructions provided.'}</div>

                        <div style="margin-top: 40px; text-align: center; opacity: 0.5;">
                            <p style="font-size: 11px;">Licensed to you. Do not distribute.</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Trigger animation
                requestAnimationFrame(() => {
                    modal.style.background = 'rgba(0,0,0,0.6)';
                    modal.style.backdropFilter = 'blur(8px)';
                    document.getElementById('modal-sheet').style.transform = 'translateY(0)';
                });

                // Close function
                window.closeModal = function () {
                    modal.style.background = 'rgba(0,0,0,0)';
                    modal.style.backdropFilter = 'blur(0px)';
                    const sheet = document.getElementById('modal-sheet');
                    if (sheet) sheet.style.transform = 'translateY(100%)';
                    setTimeout(() => modal.remove(), 400);
                }

                // Close on click outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

            } catch (e) {
                alert("Access Denied: " + e.message);
            }
        }

        loadOrders();
    </script>
</body>

</html>