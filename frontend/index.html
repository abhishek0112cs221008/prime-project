<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Project</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-brand">Prime Project</a>
        <div class="nav-links">
            <a href="dashboard.html" id="dash-link" style="display:none">
                <svg viewBox="0 0 24 24">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
                Dashboard
            </a>
            <a href="index.html" style="color: var(--accent-color)">
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
                Projects
            </a>
            <a href="cart.html" onclick="openCart(); return false;">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                </svg>
                Cart <span id="cart-count">0</span>
            </a>
            <a href="orders.html">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
                </svg>
                Orders
            </a>
            <a href="profile.html">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
                Profile
            </a>
            <span id="auth-links"></span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">◐</button>
    </nav>

    <div class="container">
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 56px; margin-bottom: 10px;">The Project Hub.</h1>
            <p style="font-size: 24px; color: var(--text-secondary);">The best way to find the projects you need.</p>
        </div>

        <!-- Category Bar -->
        <div id="category-bar" class="category-bar">
            <!-- Categories will be injected here -->
        </div>

        <!-- Recommendations Section -->
        <div id="recommendations-section" style="display: none; margin-bottom: 50px;">
            <h3 style="margin-bottom: 20px; color: var(--accent-color);">Recommended for You</h3>
            <div class="horizontal-scroll" id="rec-list"></div>
            <hr style="margin-top: 40px; border: 0; border-top: 1px solid var(--border-color); opacity: 0.5;">
        </div>

        <div id="admin-panel"
            style="display:none; text-align: left; margin-bottom: 40px; background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
            <div
                style="display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                <button onclick="showAdminTab('projects')" id="tab-projects"
                    style="background: var(--accent-color); border: none;">Manage Projects</button>
                <button onclick="showAdminTab('orders')" id="tab-orders" class="secondary"
                    style="background: transparent; border: 1px solid var(--border-color);">Manage Orders</button>
            </div>

            <!-- Manage Projects Tab -->
            <div id="admin-projects">
                <h3 id="form-title">New Project</h3>
                <input type="hidden" id="p-id">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <input id="p-name" placeholder="Project Name">
                    <input id="p-cat" placeholder="Category" list="cat-suggestions">
                    <datalist id="cat-suggestions">
                        <option value="Web App">
                        <option value="Android">
                        <option value="Java">
                        <option value="Python">
                        <option value="Machine Learning">
                    </datalist>
                    <input id="p-price" type="number" placeholder="Price (₹)">
                    <input id="p-git" placeholder="Git Repository URL (Hidden from User)">
                    <input id="p-img" placeholder="Image URL (Optional)">
                    <div style="grid-column: span 2; display: flex; gap: 20px;">
                        <input id="p-dcode" placeholder="Discount Code (e.g. SAVE20)">
                        <input id="p-dperc" type="number" placeholder="Discount %">
                    </div>
                    <div style="grid-column: span 2;">
                        <textarea id="p-desc" placeholder="Description" rows="3"></textarea>
                        <textarea id="p-install" placeholder="Installation Guidelines (Hidden from User)" rows="4"
                            style="margin-top: 10px;"></textarea>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button onclick="saveProduct()" id="btn-save">Add to Hub</button>
                            <button onclick="resetForm()" class="secondary"
                                style="background: transparent; border: 1px solid var(--border-color);">Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manage Orders Tab -->
            <div id="admin-orders" style="display: none;">
                <h3>Customer Orders</h3>
                <button onclick="loadAdminOrders()" class="secondary"
                    style="margin-bottom: 15px; font-size: 12px;">Refresh List</button>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="text-align: left; color: var(--text-secondary); font-size: 12px;">
                            <th style="padding: 10px;">DATE</th>
                            <th style="padding: 10px;">USER</th>
                            <th style="padding: 10px;">PRODUCT</th>
                            <th style="padding: 10px;">UTR / PAYMENT Ref</th>
                            <th style="padding: 10px;">STATUS</th>
                            <th style="padding: 10px;">ACTION</th>
                        </tr>
                    </thead>
                    <tbody id="admin-order-list"></tbody>
                </table>
            </div>
        </div>

        <div class="product-grid" id="product-list"></div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Copyright © 2026 Prime Project Inc. All rights reserved.</p>
            <div class="footer-links">
                <a
                    onclick="openPopup('Privacy Policy', '<strong>Privacy Policy</strong><br><br>We respect your privacy. This is a demo project, so no real data is shared with third parties. We collect email addresses only for order tracking purposes.<br><br>Your data is stored securely in our database.')">Privacy
                    Policy</a>
                <a href="#">Terms of Use</a>
                <a
                    onclick="openPopup('Contact Us', '<strong>Contact Support</strong><br><br>Email: support@primeproject.com<br>Phone: +91 98765 43210<br>Address: 123 Tech Park, Bangalore, India<br><br><strong>Working Hours:</strong><br>Mon-Fri: 9 AM - 6 PM')">Contact</a>
                <a href="#">Site Map</a>
            </div>
        </div>
    </footer>

    <!-- Bottom Nav for Mobile -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item active">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            <span>Home</span>
        </a>
        <a href="#"
            onclick="if(window.openCart) { openCart(); return false; } else { window.location.href='cart.html'; return false; }"
            class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <span>Cart</span>
        </a>
        <a href="orders.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
            </svg>
            <span>Orders</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <span>Profile</span>
        </a>
    </nav>

    <script src="js/api.js"></script>
    <script>
        const user = checkLogin();
        let allProducts = [];

        function openPopup(title, content) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; 
                display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s;
            `;
            modal.innerHTML = `
                <div style="background: var(--card-bg); width: 100%; max-width: 500px; padding: 30px; border-radius: 18px; position: relative; box-shadow: 0 20px 40px rgba(0,0,0,0.4); transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                    <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: transparent; color: var(--text-secondary); width: auto; padding: 5px; font-size: 24px;">&times;</button>
                    <h2 style="margin-top: 0; margin-bottom: 20px;">${title}</h2>
                    <div style="line-height: 1.6; color: var(--text-secondary);">
                        ${content}
                    </div>
                    <button onclick="this.closest('div').parentElement.remove()" style="margin-top: 25px;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            requestAnimationFrame(() => {
                modal.style.opacity = '1';
                modal.firstElementChild.style.transform = 'scale(1)';
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        async function loadProducts() {
            try {
                const products = await Api.get('/products');
                if (!products) return;

                const container = document.getElementById('product-list');
                container.innerHTML = products.map(renderProductCard).join('');
            } catch (e) {
                console.error("Failed to load products", e);
            }
        }

        async function loadRecommendations() {
            if (!requireLogin(false)) return; // Don't redirect, just check
            try {
                const recs = await Api.get('/products/recommendations');
                if (recs && recs.length > 0) {
                    document.getElementById('recommendations-section').style.display = 'block';
                    document.getElementById('rec-list').innerHTML = recs.map(renderProductCard).join('');
                }
            } catch (e) {
                console.error("Failed to load recommendations", e);
            }
        }

        function renderProductCard(p) {
            return `
                <div class="product-card">
                    <img src="${p.imageUrl}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">
                    <h3>${p.name}</h3>
                    <p style="font-size: 14px; margin-bottom: 5px;">${p.category}</p>
                    <p style="color: var(--text-color); margin-top: 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${p.description}</p>
                    <div style="margin-top: auto; width: 100%;">
                        <p><strong>₹${p.price.toLocaleString('en-IN')}</strong></p>
                        <div style="display: flex; gap: 10px;">
                            <button class="secondary" onclick='openDetails(${JSON.stringify(p).replace(/'/g, "&#39;")})'>View Details</button>
                            ${user && user.role === 'admin'
                    ? `<button onclick='editProduct(${JSON.stringify(p).replace(/'/g, "&#39;")})' style="padding: 0 10px;">Edit</button>
                       <button class="danger" onclick="deleteProduct(${p.id})">Remove</button>`
                    : `<button onclick="addToCart(${p.id})">Buy Now</button>`}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper to check login without redirecting immediately if just false
        function requireLogin(redirect = true) {
            const u = checkLogin();
            if (!u && redirect) {
                window.location.href = 'login.html';
                return false;
            }
            return u;
        }

        async function loadReviews(productId) {
            try {
                const reviews = await Api.get(`/reviews/${productId}`);
                const container = document.getElementById('review-list');
                if (!reviews || reviews.length === 0) {
                    container.innerHTML = '<p style="color:var(--text-secondary); font-style:italic;">No reviews yet. Be the first!</p>';
                    return;
                }
                container.innerHTML = reviews.map(r => `
                    <div style="margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;">
                         <div style="display:flex; justify-content:space-between;">
                            <p style="margin: 0; font-weight: bold;">${r.userEmail.split('@')[0]} <span style="font-weight: normal; font-size: 12px; color: #ffc107;">${'★'.repeat(r.rating)}${'☆'.repeat(5 - r.rating)}</span></p>
                            <span style="font-size:10px; color:var(--text-secondary);">${new Date(r.createdAt).toLocaleDateString()}</span>
                         </div>
                        <p style="margin: 5px 0 0 0; font-size: 13px; color: var(--text-secondary);">${r.comment}</p>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Failed to load reviews", e);
                document.getElementById('review-list').innerHTML = '<p style="color:red;">Failed to load reviews.</p>';
            }
        }

        async function submitReview(productId) {
            if (!requireLogin()) return;
            const rating = document.getElementById('r-rating').value;
            const comment = document.getElementById('r-comment').value;

            if (!comment) {
                alert("Please write a comment.");
                return;
            }

            try {
                await Api.post('/reviews', {
                    productId: productId,
                    rating: parseInt(rating),
                    comment: comment
                });
                alert('Review posted!');
                loadReviews(productId); // Refresh list
                document.getElementById('r-comment').value = '';
            } catch (e) {
                alert("Failed to post review: " + e.message);
            }
        }

        function openDetails(p) {
            const modal = document.createElement('div');
            modal.id = 'details-modal';
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0); z-index: 1000; 
                display: flex; align-items: flex-end; justify-content: center;
                transition: background 0.3s ease;
            `;

            // Inner content
            modal.innerHTML = `
                <div id="details-sheet" style="background: var(--card-bg); width: 100%; max-width: 920px; padding: 30px; border-radius: 24px 24px 0 0; position: relative; height: 90vh; max-height: 90vh; overflow-y: auto; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); box-shadow: 0 -10px 40px rgba(0,0,0,0.3); border-top: 1px solid var(--border-color);">
                    
                    <div style="width: 40px; height: 5px; background: var(--text-secondary); border-radius: 3px; margin: -10px auto 20px; opacity: 0.4;"></div>

                    <button onclick="closeDetails()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.1); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border: none; color: var(--text-color); font-size: 18px;">×</button>
                    
                    <div style="display:flex; gap:20px; align-items:flex-start;">
                        <img src="${p.imageUrl}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                        <div>
                             <h2 style="margin-top:0; font-size: 22px;">${p.name}</h2>
                             <p style="color: var(--accent-color); font-weight: 500;">${p.category}</p>
                             <h3 style="margin: 5px 0 0;">₹${p.price.toLocaleString('en-IN')}</h3>
                        </div>
                    </div>
                    
                    <button onclick="addToCart(${p.id}); closeDetails();" style="width: 100%; margin: 20px 0; padding: 14px; font-size: 16px; border-radius: 12px; font-weight: 600;">Add to Cart</button>

                    <h4 style="color: var(--text-secondary); text-transform: uppercase; font-size: 12px; letter-spacing: 1px; margin-bottom: 10px;">Description</h4>
                    <div style="line-height: 1.6; color: var(--text-secondary); margin-bottom: 30px; font-size: 15px;">${p.description}</div>
                    
                    <h4 style="color: var(--text-secondary); text-transform: uppercase; font-size: 12px; letter-spacing: 1px; margin-bottom: 15px; border-top: 1px solid var(--border-color); padding-top: 20px;">User Reviews</h4>
                    <div id="review-list" style="margin-bottom: 20px;">
                        <div style="text-align:center; color:var(--text-secondary); padding: 20px;">Loading reviews...</div>
                    </div>

                    <div style="background: var(--bg-color); padding: 20px; border-radius: 16px; border: 1px solid var(--border-color);">
                        <h5 style="margin-top:0; margin-bottom: 15px;">Write a Review</h5>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <select id="r-rating" style="flex:1; padding: 10px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; outline: none;">
                                <option value="5">★★★★★ Excellent</option>
                                <option value="4">★★★★☆ Good</option>
                                <option value="3">★★★☆☆ Average</option>
                                <option value="2">★★☆☆☆ Poor</option>
                                <option value="1">★☆☆☆☆ Terrible</option>
                            </select>
                        </div>
                        <textarea id="r-comment" placeholder="Share your experience..." rows="3" style="width: 100%; padding: 12px; margin-bottom: 10px; background: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; resize: none; outline: none;"></textarea>
                        <button onclick="submitReview(${p.id})" style="width: 100%; padding: 12px; font-size: 14px; border-radius: 8px;">Post Review</button>
                    </div>
                    <div style="height: 20px;"></div>
                </div>
            `;

            document.body.appendChild(modal);

            // Animate in
            setTimeout(() => {
                modal.style.background = 'rgba(0,0,0,0.6)';
                document.getElementById('details-sheet').style.transform = 'translateY(0)';
            }, 50);

            loadReviews(p.id);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeDetails();
            });
        }

        function closeDetails() {
            const modal = document.getElementById('details-modal');
            const sheet = document.getElementById('details-sheet');
            if (modal && sheet) {
                modal.style.background = 'rgba(0,0,0,0)';
                sheet.style.transform = 'translateY(100%)';
                setTimeout(() => modal.remove(), 350);
            }
        }

        // Admin Tabs
        function showAdminTab(tab) {
            document.querySelectorAll('#admin-panel > div[id^="admin-"]').forEach(d => d.style.display = 'none');
            document.getElementById(`admin-${tab}`).style.display = 'block';

            // Update buttons
            document.getElementById('tab-projects').className = tab === 'projects' ? '' : 'secondary';
            document.getElementById('tab-projects').style.background = tab === 'projects' ? 'var(--accent-color)' : 'transparent';

            document.getElementById('tab-orders').className = tab === 'orders' ? '' : 'secondary';
            document.getElementById('tab-orders').style.background = tab === 'orders' ? 'var(--accent-color)' : 'transparent';

            if (tab === 'orders') loadAdminOrders();
        }

        function resetForm() {
            document.getElementById('p-id').value = '';
            document.getElementById('p-name').value = '';
            document.getElementById('p-cat').value = '';
            document.getElementById('p-price').value = '';
            document.getElementById('p-git').value = '';
            document.getElementById('p-img').value = '';
            document.getElementById('p-desc').value = '';
            document.getElementById('p-install').value = '';
            document.getElementById('p-dcode').value = '';
            document.getElementById('p-dperc').value = '';
            document.getElementById('form-title').innerText = 'New Project';
            document.getElementById('btn-save').innerText = 'Add to Hub';
        }

        function editProduct(p) {
            showAdminTab('projects');
            document.getElementById('p-id').value = p.id;
            document.getElementById('p-name').value = p.name;
            document.getElementById('p-cat').value = p.category;
            document.getElementById('p-price').value = p.price;
            document.getElementById('p-img').value = p.imageUrl || '';
            document.getElementById('p-desc').value = p.description;
            // Note: gitRepoUrl and installationGuide are hidden in p object from listing, 
            // but for editing we might need to fetch them specifically if they are missing.
            // However, the current listing endpoint might not return them.
            // We should fetch the single product details if needed, but for now we'll assume admin might overwrite or we need to update getProduct to return these for admin.
            // Actually, the current listing is public. Admin needs to know these values.
            // Let's rely on the user re-entering them if they want to change them, OR better: fetch the full product details for editing.
            fetchFullProductForEdit(p.id);

            document.getElementById('form-title').innerText = 'Edit Project';
            document.getElementById('btn-save').innerText = 'Update Project';
            document.getElementById('admin-panel').scrollIntoView({ behavior: 'smooth' });
        }

        async function fetchFullProductForEdit(id) {
            try {
                const p = await Api.get(`/products/${id}/admin`);
                if (p) {
                    document.getElementById('p-git').value = p.gitRepoUrl || '';
                    document.getElementById('p-install').value = p.installationGuide || '';
                    document.getElementById('p-dcode').value = p.discountCode || '';
                    document.getElementById('p-dperc').value = p.discountPercentage || '';
                }
            } catch (e) {
                console.error("Failed to fetch full product details for edit", e);
                // Fallback or alert? Just log for now, as user can manually re-enter if needed
            }
        }

        async function saveProduct() {
            if (!requireLogin()) return;
            const id = document.getElementById('p-id').value;
            const body = {
                name: document.getElementById('p-name').value,
                category: document.getElementById('p-cat').value,
                price: parseFloat(document.getElementById('p-price').value),
                quantity: 1,
                imageUrl: document.getElementById('p-img').value,
                description: document.getElementById('p-desc').value,
                gitRepoUrl: document.getElementById('p-git').value,
                installationGuide: document.getElementById('p-install').value,
                discountCode: document.getElementById('p-dcode').value,
                discountPercentage: document.getElementById('p-dperc').value ? parseFloat(document.getElementById('p-dperc').value) : null
            };

            try {
                if (id) {
                    await Api.put(`/products/${id}`, body);
                    alert('Project updated successfully!');
                } else {
                    await Api.post('/products', body);
                    alert('Project created successfully!');
                }
                resetForm();
                loadProducts();
            } catch (e) {
                alert("Operation failed: " + e.message);
            }
        }

        async function deleteProduct(id) {
            if (!requireLogin()) return;
            if (!confirm('Are you sure you want to remove this product?')) return;
            try {
                await Api.delete(`/products/${id}`);
                loadProducts();
            } catch (e) {
                alert("Failed to remove product: " + e.message);
            }
        }

        async function loadAdminOrders() {
            try {
                const orders = await Api.get('/orders/all');
                const list = document.getElementById('admin-order-list');
                if (!orders || orders.length === 0) {
                    list.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center;">No orders found.</td></tr>';
                    return;
                }
                list.innerHTML = orders.map(o => `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 10px;">${new Date(o.orderDate).toLocaleDateString()}</td>
                        <td style="padding: 10px;">${o.userEmail}</td>
                        <td style="padding: 10px;">${o.product.name}</td>
                        <td style="padding: 10px; font-family:monospace;">
                            Must Check UTR: <b>${o.utr}</b><br>
                            <span style="font-size:10px; color:var(--text-secondary);">PaymentID: ${o.paymentId.substring(0, 8)}</span>
                        </td>
                        <td style="padding: 10px;">${o.status}</td>
                        <td style="padding: 10px;">
                            ${!o.isVerified && o.status !== 'Rejected' ?
                        `<button onclick="verifyOrderPayment(${o.id})" style="padding: 5px 10px; font-size: 12px; background: var(--success-color, #28a745);">Verify</button>
                         <button onclick="rejectOrderPayment(${o.id})" class="danger" style="padding: 5px 10px; font-size: 12px; margin-left: 5px;">Reject</button>` :
                        (o.status === 'Rejected' ? `<span style="color: red;">Rejected</span>` : `<span style="color: var(--accent-color);">Verified</span>`)
                    }
                        </td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error("Failed to load admin orders", e);
                alert("Failed to load orders: " + e.message);
            }
        }

        async function verifyOrderPayment(id) {
            if (!confirm("Confirm that you have received the payment with the UTR shown?")) return;
            try {
                await Api.put(`/orders/${id}/verify`);
                loadAdminOrders(); // Refresh table
            } catch (e) {
                alert("Verification failed: " + e.message);
            }
        }

        async function rejectOrderPayment(id) {
            const reason = prompt("Please enter the reason for rejection (e.g. Invalid UTR, Payment not received):");
            if (!reason) return;

            try {
                await Api.put(`/orders/${id}/reject`, { reason: reason });
                loadAdminOrders();
            } catch (e) {
                alert("Rejection failed: " + e.message);
            }
        }

        async function addToCart(id) {
            if (!requireLogin()) return;
            try {
                const res = await Api.post('/cart', { productId: id, quantity: 1 });
                if (res) alert('Added to your cart.');
            } catch (e) {
                if (e.message && e.message.includes("already purchased")) {
                    if (confirm("You have already purchased this project. Would you like to view your orders?")) {
                        window.location.href = 'orders.html';
                    }
                } else {
                    alert("Failed to add to cart: " + e.message);
                }
            }
        }

        loadProducts();
        loadRecommendations();
    </script>
</body>

</html>