<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prime Project - Cart</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-brand-logo">
            <span class="logo-pri">pri</span><span class="logo-me">me</span><span class="logo-project">project</span>
        </a>
        <div class="nav-links">
            <a href="index.html">
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
                Projects
            </a>
            <a href="cart.html" style="color: var(--accent-color)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                </svg>
                Cart
            </a>
            <a href="orders.html">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
                </svg>
                Orders
            </a>
            <span id="auth-links"></span>
        </div>
        <div class="flip-clock">
            <div class="flip-unit" id="hr1">0</div>
            <div class="flip-unit" id="hr2">0</div>
            <span class="clock-sep">:</span>
            <div class="flip-unit" id="min1">0</div>
            <div class="flip-unit" id="min2">0</div>
            <span class="clock-sep">:</span>
            <div class="flip-unit" id="sec1">0</div>
            <div class="flip-unit" id="sec2">0</div>
            <span class="clock-ampm" id="ampm">AM</span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">‚óê</button>
    </nav>
    <script src="js/watch.js"></script>

    <div class="container" style="padding-bottom: 120px;">
        <h1>Review your cart.</h1>
        <p style="text-align: center; margin-bottom: 40px; color: var(--text-secondary);">Your projects are just one
            step away.</p>

        <div id="cart-content-view">
            <div class="cart-list-container">
                <table>
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="cart-list"></tbody>
                </table>
            </div>

            <div class="cart-summary-card" id="cart-summary-section">
                <div style="font-size: 20px; font-weight: 600;">
                    Cart Total: <span id="cart-total" style="color: var(--accent-color);">‚Çπ0</span>
                </div>
                <button id="checkout-btn" onclick="checkout()" style="width: 240px; padding: 16px;">Secure
                    Checkout</button>
            </div>
        </div>

        <div id="empty-cart-state" style="display: none;">
            <div class="empty-cart-view">
                <div class="empty-cart-icon">üõí</div>
                <h2>Your cart is empty</h2>
                <p style="color: var(--text-secondary); margin: 10px 0 30px;">Looks like you haven't added any projects
                    yet.</p>
                <a href="index.html" class="nav-btn" style="display: inline-block; padding: 12px 30px;">Browse
                    Projects</a>
            </div>
        </div>
    </div>

    <!-- Mobile Sticky Footer Summary -->
    <div id="mobile-sticky-summary" class="cart-summary-sticky" style="display: none;">
        <div>
            <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px;">
                Total Amount</div>
            <div id="sticky-total" style="font-size: 20px; font-weight: 700; color: var(--text-color);">‚Çπ0</div>
        </div>
        <button onclick="checkout()"
            style="width: auto; padding: 12px 24px; font-size: 14px; border-radius: 12px;">Checkout Now</button>
    </div>

    <footer>
        <div class="footer-content">
            <p>Copyright ¬© 2026 Prime Project Inc. All rights reserved.</p>
            <div class="footer-links">
                <a href="#">Privacy Policy</a>
                <a href="#">Terms of Use</a>
                <a href="#">Sales and Refunds</a>
                <a href="#">Legal</a>
                <a href="#">Site Map</a>
            </div>
        </div>
    </footer>

    <!-- Bottom Nav for Mobile -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            <span>Home</span>
        </a>
        <a href="#"
            onclick="if(window.openCart) { openCart(); return false; } else { window.location.href='cart.html'; return false; }"
            class="bottom-nav-item active">
            <svg viewBox="0 0 24 24">
                <path
                    d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <span>Cart</span>
        </a>
        <a href="orders.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
            </svg>
            <span>Orders</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Duplicate Checkout Modal Removed -->

    <script src="js/api.js"></script>
    <script>
        if (!requireLogin()) throw new Error("Redirecting");

        let currentTotal = 0;
        let appliedDiscount = 0;

        async function loadCart() {
            try {
                const items = await Api.get('/cart');
                const container = document.getElementById('cart-list');
                const totalEl = document.getElementById('cart-total');
                const stickyTotalEl = document.getElementById('sticky-total');
                const checkoutBtn = document.getElementById('checkout-btn');
                const contentView = document.getElementById('cart-content-view');
                const emptyState = document.getElementById('empty-cart-state');
                const mobileSticky = document.getElementById('mobile-sticky-summary');

                if (!items || items.length === 0) {
                    contentView.style.display = 'none';
                    emptyState.style.display = 'block';
                    mobileSticky.style.display = 'none';
                    currentTotal = 0;
                    return;
                }

                contentView.style.display = 'block';
                emptyState.style.display = 'none';

                let total = 0;
                let html = '';

                items.forEach(item => {
                    if (!item.product) return;
                    const p = item.product;
                    const price = p.price || 0;
                    const quantity = item.quantity || 1;
                    const subtotal = price * quantity;
                    const img = p.imageUrl || 'https://via.placeholder.com/50?text=No+Img';
                    const name = p.name || 'Unnamed Product';

                    total += subtotal;

                    html += `
                        <tr>
                            <td data-label="Product">
                                <div style="display:flex; align-items:center; gap:12px;">
                                     <img src="${img}" style="width:60px; height:60px; object-fit:cover; border-radius:12px; border:1px solid var(--border-color);">
                                     <div style="text-align: left;">
                                        <b style="display: block; font-size: 15px;">${name}</b>
                                        <span style="font-size: 11px; color: var(--text-secondary); text-transform: uppercase;">Project ID: ${p.id}</span>
                                     </div>
                                </div>
                            </td>
                            <td data-label="Price">‚Çπ${price.toLocaleString('en-IN')}</td>
                            <td data-label="Subtotal" style="font-weight:700; color: var(--text-color);">‚Çπ${subtotal.toLocaleString('en-IN')}</td>
                            <td style="text-align:right;">
                                <button class="danger" style="width: auto; padding: 8px 12px; font-size: 12px; opacity: 0.8;" onclick="removeItem(${item.id})">Remove</button>
                            </td>
                        </tr>
                    `;
                });

                container.innerHTML = html;
                currentTotal = total;
                const formattedTotal = '‚Çπ' + total.toLocaleString('en-IN');
                totalEl.innerText = formattedTotal;
                if (stickyTotalEl) stickyTotalEl.innerText = formattedTotal;

                // Toggle Mobile Sticky based on window size (optional, or just always show if > 0)
                if (window.innerWidth <= 768) {
                    mobileSticky.style.display = 'flex';
                }

            } catch (err) {
                console.error("CRITICAL ERROR IN loadCart:", err);
                document.getElementById('cart-list').innerHTML = `<tr><td colspan="4" style="text-align:center; padding: 40px; color: red;">Failed to load cart. ${err.message}</td></tr>`;
            }
        }

        window.addEventListener('resize', () => {
            const mobileSticky = document.getElementById('mobile-sticky-summary');
            if (mobileSticky && currentTotal > 0) {
                mobileSticky.style.display = window.innerWidth <= 768 ? 'flex' : 'none';
            }
        });

        async function removeItem(id) {
            try {
                await Api.delete(`/cart/${id}`);
                loadCart();
            } catch (e) { }
        }

        function checkout() {
            if (currentTotal <= 0) return;
            const overlay = document.getElementById('checkout-modal');

            // Reset Discount
            appliedDiscount = 0;
            document.getElementById('discount-code').value = '';
            document.getElementById('final-amount').innerText = '‚Çπ' + currentTotal.toLocaleString('en-IN');
            document.getElementById('discount-msg').innerHTML = '';

            overlay.style.display = 'flex';
            // Use double rAF to guarantee transition triggers after display change
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    overlay.classList.add('active');
                });
            });
        }

        function closeCheckout() {
            const overlay = document.getElementById('checkout-modal');
            overlay.classList.remove('active');
            setTimeout(() => {
                overlay.style.display = 'none';
            }, 400);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('checkout-modal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeCheckout();
                });
            }
        });

        async function applyDiscount() {
            const code = document.getElementById('discount-code').value.trim();
            const msgEl = document.getElementById('discount-msg');
            const totalEl = document.getElementById('final-amount');

            if (!code) {
                appliedDiscount = 0;
                totalEl.innerText = '‚Çπ' + currentTotal.toLocaleString('en-IN');
                msgEl.innerHTML = '';
                return;
            }

            try {
                // We don't need to send cart items if backend fetches from DB based on user context
                const res = await Api.post('/orders/validate-discount', { code: code });

                if (res.valid) {
                    appliedDiscount = res.discountAmount;
                    const final = res.finalTotal;
                    totalEl.innerText = '‚Çπ' + final.toLocaleString('en-IN');
                    msgEl.innerHTML = `<span style="color: var(--success-color, #4caf50); font-size: 12px;">${res.message}</span>`;
                } else {
                    appliedDiscount = 0;
                    totalEl.innerText = '‚Çπ' + currentTotal.toLocaleString('en-IN');
                    msgEl.innerHTML = `<span style="color: red; font-size: 12px;">${res.message}</span>`;
                }
            } catch (e) {
                console.error("Discount validation failed", e);
                // Fallback or ignore
                appliedDiscount = 0;
                totalEl.innerText = '‚Çπ' + currentTotal.toLocaleString('en-IN');
                msgEl.innerHTML = `<span style="color: red; font-size: 12px;">Unknown error checking code.</span>`;
            }
        }

        async function confirmCheckout() {
            const utr = document.getElementById('payment-utr').value;
            const code = document.getElementById('discount-code').value;

            if (!utr) {
                alert("Please enter the Payment Reference (UTR).");
                return;
            }

            try {
                const body = {
                    shippingAddress: "Digital Delivery",
                    utr: utr,
                    discountCode: code
                };

                const res = await Api.post('/orders', body);
                if (res) {
                    closeCheckout();
                    // Show success sheet instead of alert
                    showSuccessSheet(res.paymentId);
                }
            } catch (e) {
                alert("Checkout failed: " + e.message);
            }
        }

        function showSuccessSheet(paymentId) {
            const overlay = document.getElementById('success-modal');
            const pIdEl = document.getElementById('success-payment-id');
            if (pIdEl) pIdEl.innerText = paymentId;

            overlay.style.display = 'flex';
            // Force reflow and animate
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    overlay.classList.add('active');
                });
            });
        }

        function goToOrders() {
            window.location.href = 'orders.html';
        }

        loadCart().catch(e => {
            console.error("Critical error loading cart:", e);
        });
    </script>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="sheet-overlay">
        <div id="checkout-sheet" class="bottom-sheet">
            <div class="sheet-handle"></div>
            <button class="sheet-close-btn" onclick="closeCheckout()">√ó</button>

            <h2 style="margin-top:0; margin-bottom: 5px;">Secure Checkout</h2>
            <p style="margin-bottom:20px; font-size:14px; color:var(--text-secondary);">Total Payable: <strong
                    id="final-amount" style="color: var(--text-color); font-size: 16px;">‚Çπ0</strong></p>

            <div style="margin-bottom:20px; text-align:center;">
                <img src="images/payment_qr.png"
                    style="width:150px; height:150px; border-radius:10px; border:1px solid var(--border-color);">
                <p style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">Scan to Pay</p>
            </div>

            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:5px; font-size:13px;">Payment Reference (UTR)</label>
                <input id="payment-utr" placeholder="UPI12345678"
                    style="width:100%; padding:12px; background:var(--bg-color); border:1px solid var(--border-color); color:var(--text-color); border-radius:10px;">
            </div>

            <div style="margin-bottom:25px;">
                <label style="display:block; margin-bottom:5px; font-size:13px;">Discount Code</label>
                <div style="display: flex; gap: 10px;">
                    <input id="discount-code" placeholder="SAVE10" oninput="applyDiscount()"
                        style="flex: 1; padding:12px; background:var(--bg-color); border:1px solid var(--border-color); color:var(--text-color); border-radius:10px;">
                </div>
                <div id="discount-msg" style="margin-top: 5px; min-height: 15px;"></div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="closeCheckout()"
                    style="flex:1; background:transparent; border:1px solid var(--border-color); color:var(--text-color); border-radius:10px; padding: 12px;">Cancel</button>
                <button onclick="confirmCheckout()" style="flex:2; border-radius:10px; padding: 12px;">Pay & Place
                    Order</button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="sheet-overlay">
        <div class="bottom-sheet" style="text-align: center; padding: 40px 30px;">
            <div style="font-size: 60px; margin-bottom: 20px;">üéâ</div>
            <h2 style="margin-bottom: 10px;">Order Placed!</h2>
            <p style="color: var(--text-secondary); margin-bottom: 30px;">Your purchase was successful. Payment ID:
                <br><strong id="success-payment-id" style="color: var(--text-color);"></strong>
            </p>
            <button onclick="goToOrders()" style="padding: 14px 40px; width: auto; border-radius: 12px;">View My
                Orders</button>
        </div>
    </div>
</body>

</html>