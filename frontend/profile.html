<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Prime Project</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <nav class="nav">
        <a href="index.html" class="nav-brand-logo">
            <span class="logo-pri">pri</span><span class="logo-me">me</span><span class="logo-project">project</span>
        </a>
        <div class="nav-links">
            <a href="dashboard.html" id="dash-link" style="display:none">
                <svg viewBox="0 0 24 24">
                    <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
                </svg>
                Dashboard
            </a>
            <a href="index.html">
                <svg viewBox="0 0 24 24">
                    <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                </svg>
                Projects
            </a>
            <a href="cart.html">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
                </svg>
                Cart
            </a>
            <a href="orders.html">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
                </svg>
                Orders
            </a>
            <a href="profile.html" style="color: var(--accent-color)">
                <svg viewBox="0 0 24 24">
                    <path
                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                </svg>
                Profile
            </a>
            <span id="auth-links"></span>
        </div>
        <div class="flip-clock">
            <div class="flip-unit" id="hr1">0</div>
            <div class="flip-unit" id="hr2">0</div>
            <span class="clock-sep">:</span>
            <div class="flip-unit" id="min1">0</div>
            <div class="flip-unit" id="min2">0</div>
            <span class="clock-sep">:</span>
            <div class="flip-unit" id="sec1">0</div>
            <div class="flip-unit" id="sec2">0</div>
            <span class="clock-ampm" id="ampm">AM</span>
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">◐</button>
    </nav>
    <script src="js/watch.js"></script>

    <div class="container" style="max-width: 800px; padding-top: 20px;">
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('details')">Profile Details</div>
            <div class="tab-btn" onclick="switchTab('history')">Order History</div>
        </div>

        <!-- Profile Details Section -->
        <div id="tab-details" class="profile-container">
            <div class="profile-header">
                <div class="profile-avatar" id="avatar-initials">U</div>
                <div class="profile-title-group">
                    <h2 id="display-name">User Name</h2>
                    <p id="display-email">user@example.com</p>
                </div>
            </div>

            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="p-name" placeholder="Your Name"
                    oninput="document.getElementById('display-name').innerText = this.value || 'User Name'">
            </div>

            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="p-email" disabled style="opacity: 0.6; cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label>Your Interests</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="interest-input" placeholder="Type (e.g. Java, React) and press Enter">
                    <button onclick="addInterest()" style="width: auto; padding: 0 20px;">Add</button>
                </div>
                <div class="interest-suggestions">
                    <span class="suggestion-chip" onclick="addSuggestion('Java')">+ Java</span>
                    <span class="suggestion-chip" onclick="addSuggestion('Web Development')">+ Web Dev</span>
                    <span class="suggestion-chip" onclick="addSuggestion('Python')">+ Python</span>
                    <span class="suggestion-chip" onclick="addSuggestion('React')">+ React</span>
                    <span class="suggestion-chip" onclick="addSuggestion('ML')">+ ML</span>
                </div>
                <div id="interests-list" class="tag-container"></div>
            </div>

            <button onclick="saveProfile()" style="width: 100%; margin-top: 10px;">Save Changes</button>
            <p id="success-msg" class="message-success" style="text-align: center; margin-top: 15px;">Profile updated
                successfully!</p>

            <div class="logout-section">
                <button onclick="logout(event)" class="btn-logout">Sign Out from Account</button>
            </div>
        </div>

        <!-- Order History Section -->
        <div id="tab-history" style="display: none;">
            <h2 style="margin-bottom: 20px;">My Order History</h2>
            <div id="order-list">
                <div style="text-align: center; padding: 40px; color: var(--text-secondary);">Loading orders...</div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>Copyright © 2026 Prime Project Inc. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bottom Nav for Mobile -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
            </svg>
            <span>Home</span>
        </a>
        <a href="#"
            onclick="if(window.openCart) { openCart(); return false; } else { window.location.href='cart.html'; return false; }"
            class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
            <span>Cart</span>
        </a>
        <a href="orders.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z" />
            </svg>
            <span>Orders</span>
        </a>
        <a href="profile.html" class="bottom-nav-item active">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <span>Profile</span>
        </a>
    </nav>

    <script src="js/api.js"></script>
    <script>
        const user = checkLogin();
        let myInterests = [];

        if (!user) {
            window.location.href = 'login.html';
        }

        // Initialize
        (async function init() {
            if (user) {
                // Populate default from localstorage immediately
                document.getElementById('p-name').value = user.name || '';
                document.getElementById('display-name').innerText = user.name || 'User Name';
                document.getElementById('p-email').value = user.email || '';
                document.getElementById('display-email').innerText = user.email || '';
                document.getElementById('avatar-initials').innerText = (user.name || 'U').charAt(0).toUpperCase();

                // Fetch fresh user data including interests
                try {
                    const freshUser = await Api.get('/auth/me');
                    if (freshUser) {
                        document.getElementById('p-name').value = freshUser.name;
                        document.getElementById('display-name').innerText = freshUser.name;
                        document.getElementById('p-email').value = freshUser.email;
                        document.getElementById('display-email').innerText = freshUser.email;
                        document.getElementById('avatar-initials').innerText = (freshUser.name || 'U').charAt(0).toUpperCase();

                        if (freshUser.interests && freshUser.interests.length > 0) {
                            myInterests = freshUser.interests.split(',').map(s => s.trim()).filter(s => s);
                            renderInterests();
                        }
                    }
                } catch (e) {
                    console.error("Failed to fetch user profile", e);
                }
            }
        })();

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');

            if (tab === 'details') {
                document.getElementById('tab-details').style.display = 'block';
                document.getElementById('tab-history').style.display = 'none';
            } else {
                document.getElementById('tab-details').style.display = 'none';
                document.getElementById('tab-history').style.display = 'block';
                loadOrders();
            }
        }

        // Interest Logic
        const input = document.getElementById('interest-input');
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addInterest();
            }
        });

        function addInterest() {
            const val = input.value.trim();
            if (val && !myInterests.includes(val)) {
                myInterests.push(val);
                renderInterests();
                input.value = '';
            }
        }

        function addSuggestion(val) {
            if (!myInterests.includes(val)) {
                myInterests.push(val);
                renderInterests();
            }
        }

        function removeInterest(val) {
            myInterests = myInterests.filter(i => i !== val);
            renderInterests();
        }

        function renderInterests() {
            const container = document.getElementById('interests-list');
            container.innerHTML = myInterests.map(i => `
                <div class="tag">
                    ${i}
                    <span onclick="removeInterest('${i}')">&times;</span>
                </div>
            `).join('');
        }

        async function saveProfile() {
            const name = document.getElementById('p-name').value;
            const interestsStr = myInterests.join(',');

            try {
                const res = await Api.put('/auth/profile', {
                    name: name,
                    interests: interestsStr
                });

                // Show success message
                const msg = document.getElementById('success-msg');
                msg.style.display = 'block';
                setTimeout(() => msg.style.display = 'none', 3000);
            } catch (e) {
                alert("Failed to update profile: " + e.message);
            }
        }

        // Order History Logic
        async function loadOrders() {
            try {
                const orders = await Api.get('/orders');
                const list = document.getElementById('order-list');

                if (!orders || orders.length === 0) {
                    list.innerHTML = '<div style="background: var(--card-bg); padding: 30px; border-radius: 12px; text-align: center; color: var(--text-secondary);">You haven\'t placed any orders yet.</div>';
                    return;
                }

                list.innerHTML = orders.map(o => `
                    <div class="order-card">
                        <div class="order-info">
                            <h4>${o.product.name}</h4>
                            <p>Order Date: ${new Date(o.orderDate).toLocaleDateString()}</p>
                            <p>Price: ₹${o.product.price.toLocaleString('en-IN')}</p>
                        </div>
                        <div style="text-align: right;">
                             <span class="status-badge ${o.status === 'Rejected' ? 'status-rejected' : (o.isVerified ? 'status-verified' : 'status-pending')}" style="${o.status === 'Rejected' ? 'color: red; background: rgba(255,0,0,0.1);' : ''}">
                                ${o.status || (o.isVerified ? 'Verified' : 'Pending Verification')}
                            </span>
                            ${o.status === 'Rejected' && o.rejectionReason ? `<div style="font-size: 11px; color: red; margin-top: 5px;">Reason: ${o.rejectionReason}</div>` : ''}
                            ${o.isVerified ?
                        `<div style="margin-top: 8px;">
                                    <a href="${o.product.gitRepoUrl}" target="_blank" style="color: var(--accent-color); font-size: 13px; text-decoration: none;">View Repository →</a>
                                </div>`
                        : ''
                    }
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Failed to load orders", e);
                document.getElementById('order-list').innerHTML = '<p style="color: red;">Failed to load history.</p>';
            }
        }
    </script>
</body>

</html>